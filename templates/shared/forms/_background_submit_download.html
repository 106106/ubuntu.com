<!-- background submit download inlcude start -->
<!-- dependencies -->
<script src="{{ ASSET_SERVER_URL }}ec520d10-XMLHttpRequest.min.js"></script>
<script src="{{ ASSET_SERVER_URL }}4176b39e-serialize.js"></script>
<script src="{{ ASSET_SERVER_URL }}6b7597df-event-listener-polyfill.js"></script>

<!-- script -->
<script>
  /**
  * Given a form element, extract its data and its "action" target URL
  * and submit the form using Ajax
  */
  backgroundSubmit = function(formElement, submitCallback) {
    var request = new XMLHttpRequest();
    var submitUrl = formElement.getAttribute('action');
    var formData = serialize(formElement);

    request.open("POST", submitUrl, true);

    //Send the proper header information along with the request
    request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

    // When request has finished, call the callback function
    if (submitCallback) {
      request.addEventListener(
      'readystatechange',
      function() {
        if (this.readyState == 4) {
          // Pass context and arguments on to submitCallback
          submitCallback.apply(this, arguments);
        }
      }
      );
    }

    // Send off the POST request
    request.send(formData);
  }

  /**
  * After submit has happened
  * start download and send the user to the instructions page
  */

  afterSubmit = function() {

    // Now start the download
    console.log('got to afterSubmit');
    downloadFrame = document.createElement("iframe");
    downloadFrame.setAttribute("src", "{{ download_asset_url }}");
    downloadFrame.style.width = 0 + "px";
    downloadFrame.style.height = 0 + "px";
    document.body.insertBefore(downloadFrame, document.body.childNodes[0]);
    // And redirect to the instructions page
    window.setTimeout(
    function() {
      window.location.href = "{{ return_url|default:"" }}";
    },
    1000
    );
  }

  /**
  * Handler for a form submit event
  * to disable the normal submit, and instead use backgroundSubmit
  */
  backgroundSubmitHandlerClosure = function($) {

    return function(submitEvent) {
      // Prevent normal submit
      submitEvent.preventDefault ? submitEvent.preventDefault() : submitEvent.returnValue = false;
      marketoForm = document.getElementById(submitEvent.target.id);

      // Check form is valid
      if ($(marketoForm).valid()) {

        // copy recaptcha into a new <fieldset>
        var input = marketoForm.querySelector('[name=grecaptcharesponse]')
        if (! input) {
          input = document.createElement('input');
          input.type = 'hidden';
          input.name = "grecaptcharesponse";
          this.appendChild(input);
        }
        input.value = grecaptcha.getResponse();

        // Change the submit location
        marketoForm.action = "https://app-sjg.marketo.com/index.php/leadCapture/save2";
        // Submit the form in the background
        backgroundSubmit(marketoForm, afterSubmit);
      }
    }
  }

  // Attach the submit handler to the form
  document.querySelectorAll('.marketo-form').forEach(function(form) {
    form.addEventListener(
    'submit',
    backgroundSubmitHandlerClosure(jQuery)
    )
  });
</script>
<!-- background submit download inlcude end -->
