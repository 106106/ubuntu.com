{% extends "templates/base.html" %}

{% block title %}Activate Ubuntu Pro subscription{% endblock %}

{% block outer_content %}
  {% block content %}
  {% if needs_paid_account_created %}
    <div class="p-modal" id="modal">
      <section class="p-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-description">
        <header class="p-modal__header">
          <h2 class="p-modal__title" id="modal-title">Activating for a company or yourself?</h2>
        </header>
        <form id="create-purchase-account-form">
          <div class="js-organisation-container u-sv3">
            <div class="col-4">
              <label class="p-radio">
                <input class="p-radio__input radio-myself" type="radio" aria-labelledby="activate-myself-input" name="activate-buy-for" value="myself" required>
                <span class="p-radio__label" id="activate-myself">Myself</span>
                <input type="hidden" name="activate-name" value="{{ user_info.fullname }}">
              </label>
            </div>
            <div class="col-4">
              <label class="p-radio">
                <input class="p-radio__input radio-organisation" type="radio" aria-labelledby="activate-organisation-input" name="activate-buy-for" value="organisation">
                <span class="p-radio__label" id="activate-organisation">Organisation</span>
              </label>
              <div class="p-form__group js-organisation-name-container" style="display:none">
                <label for="activate-organisation-name" class="p-form__label">Organisation name: </label>
                <input class="u-no-margin--bottom" type="text" id="activate-organisation-name" name="activate-organisation-name" placeholder="Ex: Canonical" style="margin-top: .25rem;" aria-label="What?">
              </div>
            </div>
          </div>
          <button class="p-button--positive" type="submit" name="submit">Submit</button>
        </form>
      </section>
    </div>
  {% endif %}

  <section class="p-strip">
    <div class="u-fixed-width">
      <h2>Activate your Ubuntu Pro subscription</h2>
      <p>
        You are currently signed in as {{ name }}. Make sure it is the
        account you will be using to manage your subscription. If not, <a href="https://login.ubuntu.com/+login">log in
        to a different account</a>.
      </p>
      <p>
        Your product key should be in the confirmation email you received
        after buying your Ubuntu Pro Desktop subscription.
      </p>
      <p>The activation key is 23 characters long and starts with a K.</p>
      <form id="activate-key-form">
        <div class="p-form__group">
          <label for="pro-activation-key" class="p-form__label">Enter your code</label>
          <div class="p-form__control is-error" style="min-width: 15rem">
            <input type="text" id="pro-activation-key" class="activate-input" name="key" autocomplete="off" placeholder="Ex: Kabcedfghij12345678910-" required="" aria-describedby="pro-activate-input">
            <p class="p-form-validation__message" id="pro-activatio-validation__message"></p>
          </div>
        </div>
        <button class="p-button--positive" type="submit" name="submit">Activate</button>
      </form>
    </div>
    <div class="u-fixed-width">
      <div class="p-notification--negative" id="notification" style="display: none">
        <div class="p-notification__content">
          <h5 class="p-notification__title">Error</h5>
            <p class="p-notification__message" id="notification-message"></p>
        </div>
        <div class="p-notification__meta">
          <div class="p-notification__actions">
            <a class="p-notification__action p-button" href="/pro/dashboard">Go to dashboard</a>
          </div>
        </div>
      </div>
    </div>
  </section>
  <script>
    // validate messages for keys
    const activation_key = document.querySelector(".activate-input");
    const validate_message =  document.querySelector(".p-form-validation__message");

    function validateKey(e){
      const firstLetter = "The activation key starts with a K.";
      const length = "The activation key is 23 characters long.";
      const notification = document.querySelector("#notification");

      if (e.target.value.length === 0) {
        validate_message.textContent = "";
      } else if (e.target.value.charAt(0) !== "K") {
        validate_message.textContent = firstLetter;
      } else if (e.target.value.length !== 23) {
        validate_message.textContent = length;
      } else if (e.target.value.charAt(0) === "K" && e.target.value.length === 23) {
        validate_message.textContent = "";
      }
    }
    activation_key.addEventListener("keyup", validateKey);

    // JS for modal
    (function () {
      var currentDialog = null;
      var lastFocus = null;
      var ignoreFocusChanges = false;
      var focusAfterClose = null;

      // Traps the focus within the currently open modal dialog
      function trapFocus(event) {
        if (ignoreFocusChanges) return;

        if (currentDialog.contains(event.target)) {
          lastFocus = event.target;
        } else {
          focusFirstDescendant(currentDialog);
          if (lastFocus == document.activeElement) {
            focusLastDescendant(currentDialog);
          }
          lastFocus = document.activeElement;
        }
      }

      // Attempts to focus given element
      function attemptFocus(child) {
        if (child.focus) {
          ignoreFocusChanges = true;
          child.focus();
          ignoreFocusChanges = false;
          return document.activeElement === child;
        }

        return false;
      }

      // Focuses first child element
      function focusFirstDescendant(element) {
        for (var i = 0; i < element.childNodes.length; i++) {
          var child = element.childNodes[i];
          if (attemptFocus(child) || focusFirstDescendant(child)) {
            return true;
          }
        }
        return false;
      }

      // Focuses last child element
      function focusLastDescendant(element) {
        for (var i = element.childNodes.length - 1; i >= 0; i--) {
          var child = element.childNodes[i];
          if (attemptFocus(child) || focusLastDescendant(child)) {
            return true;
          }
        }
        return false;
      }

      /**
        Toggles visibility of modal dialog.
        @param {HTMLElement} modal Modal dialog to show or hide.
        @param {HTMLElement} sourceEl Element that triggered toggling modal
        @param {Boolean} open If defined as `true` modal will be opened, if `false` modal will be closed, undefined toggles current visibility.
      */
      function toggleModal(modal, sourceEl, open) {
        if (modal && modal.classList.contains('p-modal')) {
          if (typeof open === 'undefined') {
            open = modal.style.display === 'none';
          }

          if (open) {
            currentDialog = modal;
            modal.style.display = 'flex';
            focusFirstDescendant(modal);
            focusAfterClose = sourceEl;
            document.addEventListener('focus', trapFocus, true);
          } else {
            modal.style.display = 'none';
            if (focusAfterClose && focusAfterClose.focus) {
              focusAfterClose.focus();
            }
            document.removeEventListener('focus', trapFocus, true);
            currentDialog = null;
          }
        }
      }

      toggleModal(document.querySelector('#modal'), document.querySelector('[aria-controls=modal]'), true);
    })();

    // buying for input
    var shouldCreateAccount = document.querySelector("#create-purchase-account-form");
    if (shouldCreateAccount) {
      const organisationContainer = document.querySelector(".js-organisation-container");
      const radioMyself = organisationContainer.querySelector(
        ".radio-myself"
      );
      const radioOrganisation = organisationContainer.querySelector(
        ".radio-organisation"
      );
      const organisationNameContainer = organisationContainer.querySelector(".js-organisation-name-container");
      const organisationNameInput = organisationNameContainer.querySelector('input[name="activate-organisation-name"]')
      radioOrganisation.addEventListener("change", function (e) {
        if (e.target.checked) {
          organisationNameContainer.style.display = "block";
          organisationNameContainer.focus();
          organisationNameInput.setAttribute("required", true);
        }
      });
      radioMyself.addEventListener("change", function (e) {
        if (e.target.checked) {
          organisationNameContainer.style.display = "none";
          organisationNameInput.removeAttribute("required");
        }
      });

      const createPurchaseAccountForm = document.getElementById("create-purchase-account-form");

      createPurchaseAccountForm.addEventListener("submit", function(event) {
        event.preventDefault();
        const selectedOption = document.querySelector('input[name="activate-buy-for"]:checked');

        let accountName = document.querySelector('input[name="activate-name"]').value;
        if (selectedOption.value == "organisation") {
          accountName = document.querySelector('input[name="activate-organisation-name"]').value;
        }

        fetch("/account/purchase-account", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            marketplace: "canonical-ua",
            account_name: accountName,
          })
        }).then(function(response) {
            if (response.status != 200) {
              throw new Error("Error: " + response.status);
            }
          })
          .then(function(data) {
            location.reload();
          })
          .catch(function(error) {
            console.error(error);
          })
      });
    }

    const activateKeyForm = document.getElementById("activate-key-form");
    
    activateKeyForm.addEventListener("submit", function(event) {
      event.preventDefault();
      
      const key = document.querySelector('input[name="key"]').value;
      fetch("/pro/activate", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          "key": key,
        })
      }).then(function(response) {
          if (response.status != 200) {
            throw new Error(response);
          }
        })
        .then(function() {
          window.location.replace = "/pro/dashboard"
        })
        .catch(function(error) {
          console.error("error", error);
          document.querySelector('#notification').style.display = "block";
          document.querySelector('#notification-message').innerHTML = error;
        })
    });
  </script>
  {% endblock %}
{% endblock %}
